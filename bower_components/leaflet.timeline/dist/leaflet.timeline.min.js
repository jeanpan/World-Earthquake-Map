(function(){var t;L.TimelineVersion="0.4.3",t=function(){function t(){this._root=null,this._list=null}return t.prototype.insert=function(t,e,i,n,s,r){var o;return void 0===n&&(n=this._root),n?(o=t<n.low||t===n.low&&e<n.high?this.insert(t,e,i,n.left,n,"left"):this.insert(t,e,i,n.right,n,"right"),n.max=Math.max(n.max,o.max),o):(o={low:t,high:e,max:e,data:i,left:null,right:null,parent:s},s?s[r]=o:this._root=o,o)},t.prototype.lookup=function(t,e){return void 0===e&&(e=this._root,this._list=[]),null===e||e.max<t?[]:(null!==e.left&&this.lookup(t,e.left),e.low<=t&&(e.high>=t&&this._list.push(e.data),this.lookup(t,e.right)),this._list)},t}(),L.Timeline=L.GeoJSON.extend({includes:L.Mixin.Events,times:[],displayedLayers:[],ranges:null,options:{position:"bottomleft",formatDate:function(t){return""},enablePlayback:!0,enableKeyboardControls:!1,steps:1e3,duration:1e4,showTicks:!0,waitToUpdateMap:!1},initialize:function(e,i){return this.times=[],L.GeoJSON.prototype.initialize.call(this,void 0,i),L.extend(this.options,i),this.ranges=new t,null!=i.intervalFromFeature&&(this.intervalFromFeature=i.intervalFromFeature.bind(this)),null!=i.addData&&(this.addData=i.addData.bind(this)),null!=i.doSetTime&&(this.doSetTime=i.doSetTime.bind(this)),null!=e?this.process(e):void 0},intervalFromFeature:function(t){return{start:new Date(t.properties.start).getTime(),end:new Date(t.properties.end).getTime()}},process:function(t){var e,i;return e=1/0,i=-(1/0),t.features.forEach(function(t){return function(n){var s;return s=t.intervalFromFeature(n),t.ranges.insert(s.start,s.end,n),t.times.push(s.start),t.times.push(s.end),s.start<e&&(e=s.start),s.end>i?i=s.end:void 0}}(this)),this.times=this.times.sort(function(t,e){return t-e}),this.times=this.times.reduce(function(t,e){return t[t.length-1]!==e&&t.push(e),t},[]),this.options.start||(this.options.start=e),this.options.end?void 0:this.options.end=i},addData:function(t){var e,i,n,s;if(i=L.Util.isArray(t)?t:t.features){for(n=0,s=i.length;s>n;n++)e=i[n],(e.geometries||e.geometry||e.features||e.coordinates)&&this.addData(e);return this}return this._addData(t)},_addData:function(t){var e,i,n,s,r,o,a,l,h,u,d,m,p,c;return u=this.options,!u.filter||u.filter(t)?(c=/^(\d+)(\.(\d+))?(\.(\d+))?(-(.*))?(\+(.*))?$/,p=c.exec(L.version),e=p[0],a=p[1],i=p[2],h=p[3],n=p[4],d=p[5],s=p[6],m=p[7],r=p[8],l=p[9],o=0===parseInt(a)&&parseInt(h)<=7?L.GeoJSON.geometryToLayer(t,u.pointToLayer):L.GeoJSON.geometryToLayer(t,u),this.displayedLayers.push({layer:o,geoJSON:t}),o.feature=L.GeoJSON.asFeature(t),o.defaultOptions=o.options,this.resetStyle(o),u.onEachFeature&&u.onEachFeature(t,o),this.addLayer(o)):void 0},removeLayer:function(t,e){return null==e&&(e=!0),L.GeoJSON.prototype.removeLayer.call(this,t),e?this.displayedLayers=this.displayedLayers.filter(function(e){return e.layer!==t}):void 0},setTime:function(t){return this.time=new Date(t).getTime(),this.doSetTime(t),this.fire("change")},doSetTime:function(t){var e,i,n,s,r;s=this.ranges.lookup(t);var e,o,a;for(e=0;e<this.displayedLayers.length;e++){for(a=!1,o=0;o<s.length;o++)if(this.displayedLayers[e].geoJSON===s[o]){a=!0,s.splice(o,1);break}if(!a){var l=this.displayedLayers.splice(e--,1);this.removeLayer(l[0].layer,!1)}}for(r=[],e=0,i=s.length;i>e;e++)n=s[e],r.push(this.addData(n));return r},onAdd:function(t){return L.GeoJSON.prototype.onAdd.call(this,t),this.timeSliderControl=L.Timeline.timeSliderControl(this),this.timeSliderControl.addTo(t)},onRemove:function(t){return L.GeoJSON.prototype.onRemove.call(this,t),this.timeSliderControl.removeFrom(t)},getDisplayed:function(){return this.ranges.lookup(this.time)}}),L.Timeline.TimeSliderControl=L.Control.extend({initialize:function(t){return this.timeline=t,this.options.position=this.timeline.options.position,this.start=this.timeline.options.start,this.end=this.timeline.options.end,this.showTicks=this.timeline.options.showTicks,this.stepDuration=this.timeline.options.duration/this.timeline.options.steps,this.stepSize=(this.end-this.start)/this.timeline.options.steps},_buildDataList:function(t,e){var i;return this._datalist=L.DomUtil.create("datalist","",t),i=L.DomUtil.create("select","",this._datalist),e.forEach(function(t){var e;return e=L.DomUtil.create("option","",i),e.value=t}),this._datalist.id="timeline-datalist-"+Math.floor(1e6*Math.random()),this._timeSlider.setAttribute("list",this._datalist.id)},_makePlayPause:function(t){return this._playButton=L.DomUtil.create("button","play",t),this._playButton.addEventListener("click",function(t){return function(){return t._play()}}(this)),L.DomEvent.disableClickPropagation(this._playButton),this._pauseButton=L.DomUtil.create("button","pause",t),this._pauseButton.addEventListener("click",function(t){return function(){return t._pause()}}(this)),L.DomEvent.disableClickPropagation(this._pauseButton)},_makePrevNext:function(t){return this._prevButton=L.DomUtil.create("button","prev"),this._nextButton=L.DomUtil.create("button","next"),this._playButton.parentNode.insertBefore(this._prevButton,this._playButton),this._playButton.parentNode.insertBefore(this._nextButton,this._pauseButton.nextSibling),L.DomEvent.disableClickPropagation(this._prevButton),L.DomEvent.disableClickPropagation(this._nextButton),this._prevButton.addEventListener("click",this._prev.bind(this)),this._nextButton.addEventListener("click",this._next.bind(this))},_makeSlider:function(t){return this._timeSlider=L.DomUtil.create("input","time-slider",t),this._timeSlider.type="range",this._timeSlider.min=this.start,this._timeSlider.max=this.end,this._timeSlider.value=this.start,this._timeSlider.addEventListener("mousedown",function(t){return function(){return t.map.dragging.disable()}}(this)),document.addEventListener("mouseup",function(t){return function(){return t.map.dragging.enable()}}(this)),this._timeSlider.addEventListener("input",this._sliderChanged.bind(this)),this._timeSlider.addEventListener("change",this._sliderChanged.bind(this))},_makeOutput:function(t){return this._output=L.DomUtil.create("output","time-text",t),this._output.innerHTML=this.timeline.options.formatDate(new Date(this.start))},_addKeyListeners:function(){return this._listener=this._onKeydown.bind(this),document.addEventListener("keydown",this._listener)},_removeKeyListeners:function(){return document.removeEventListener("keydown",this._listener)},_onKeydown:function(t){switch(t.keyCode||t.which){case 37:this._prev();break;case 39:this._next();break;case 32:this._toggle();break;default:return}return t.preventDefault()},_nearestEventTime:function(t,e){var i,n,s,r,o,a,l,h;for(null==e&&(e=0),l=!1,n=this.timeline.times[0],a=this.timeline.times.slice(1),i=0,s=a.length;s>i;i++){if(h=a[i],l)return h;if(h>=t){if(-1===e)return n;if(1!==e)return o=Math.abs(t-n),r=Math.abs(h-t),r>o?o:r;if(h!==t)return h;l=!0}n=h}return n},_toggle:function(){return this._playing?this._pause():this._play()},_prev:function(){var t;return this._pause(),t=this._nearestEventTime(this.timeline.time,-1),this._timeSlider.value=t,this._sliderChanged({type:"change",target:{value:t}})},_pause:function(){return clearTimeout(this._timer),this._playing=!1,this.container.classList.remove("playing")},_play:function(){return clearTimeout(this._timer),+this._timeSlider.value===this.end&&(this._timeSlider.value=this.start),this._timeSlider.value=+this._timeSlider.value+this.stepSize,this._sliderChanged({type:"change",target:{value:this._timeSlider.value}}),+this._timeSlider.value!==this.end?(this._playing=!0,this.container.classList.add("playing"),this._timer=setTimeout(this._play.bind(this,this.stepDuration))):(this._playing=!1,this.container.classList.remove("playing"))},_next:function(){var t;return this._pause(),t=this._nearestEventTime(this.timeline.time,1),this._timeSlider.value=t,this._sliderChanged({type:"change",target:{value:t}})},_sliderChanged:function(t){var e;return e=+t.target.value,this.timeline.options.waitToUpdateMap&&"change"!==t.type||this.timeline.setTime(e),this._output.innerHTML=this.timeline.options.formatDate(new Date(e))},onAdd:function(t){var e,i,n;return this.map=t,i=L.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded leaflet-timeline-controls"),this.timeline.options.enablePlayback&&(n=L.DomUtil.create("div","sldr-ctrl-container",i),e=L.DomUtil.create("div","button-container",n),this._makePlayPause(e),this._makePrevNext(e),this.timeline.options.enableKeyboardControls&&this._addKeyListeners()),this._makeSlider(i),this._makeOutput(n),this.showTicks&&this._buildDataList(i,this.timeline.times),this.timeline.setTime(this.start),this.container=i},onRemove:function(){return this.timeline.options.enableKeyboardControls?this._removeKeyListeners():void 0}}),L.timeline=function(t,e){return new L.Timeline(t,e)},L.Timeline.timeSliderControl=function(t,e,i,n){return new L.Timeline.TimeSliderControl(t,e,i,n)}}).call(this);